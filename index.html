<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperTransfer Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- JSZip for ZIP generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap');

        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #0f172a;
            --bg-main: #f8fafc;
            --card-bg: #ffffff;
            --border-color: rgba(226, 232, 240, 0.8);
            --text-main: #0f172a;
            --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .premium-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.02), 0 1px 2px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -4px rgba(0, 0, 0, 0.04);
            border-color: rgba(203, 213, 225, 0.8);
        }

        .paste-zone {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .paste-zone:hover {
            border-color: var(--primary);
            background-color: #f5f3ff;
            transform: translateY(-1px);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-section {
            animation: slideUp 0.5s ease-out forwards;
        }

        /* Segmented Control Styling */
        .segmented-control input:checked+span {
            background-color: white;
            color: var(--primary);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }
    </style>
</head>


<body class="min-h-screen">

    <div class="max-w-7xl mx-auto p-4 md:p-12 flex flex-col lg:flex-row gap-12">

        <!-- Sidebar: Session History -->
        <aside class="w-full lg:w-72 flex-shrink-0">
            <div class="premium-card rounded-2xl p-6 sticky top-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-[11px] font-bold text-slate-400 uppercase tracking-[0.2em]">Activity</h2>
                    <button id="manage-btn" onclick="toggleSelectionMode()"
                        class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors bg-indigo-50 px-2.5 py-1 rounded-lg">Manage</button>
                </div>

                <div id="session-history-list" class="flex flex-col gap-1.5 max-h-[50vh] overflow-y-auto pr-2">
                    <!-- History items injected here -->
                    <div class="text-xs text-slate-400 py-4">Loading sessions...</div>
                </div>

                <!-- Bulk Actions (Hidden by default) -->
                <div id="bulk-actions" class="hidden mt-6 pt-6 border-t border-slate-100 flex flex-col gap-2">
                    <button onclick="toggleSelectAll()" id="select-all-btn"
                        class="w-full py-2.5 bg-slate-50 text-slate-600 rounded-xl hover:bg-slate-100 text-[11px] font-bold uppercase tracking-wider transition-all">
                        Select All
                    </button>
                    <button onclick="deleteSelectedSessions()" id="bulk-del-btn"
                        class="w-full py-2.5 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 text-[11px] font-bold uppercase tracking-wider transition-all">
                        üóëÔ∏è Delete Selected (0)
                    </button>
                </div>

                <div id="sidebar-divider" class="my-6 border-t border-slate-100"></div>
                <button id="new-session-btn" onclick="startNewSession()"
                    class="w-full py-3.5 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 text-sm font-semibold transition-all shadow-indigo-200 shadow-xl active:scale-[0.98] flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4">
                        </path>
                    </svg>
                    New Portal
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow max-w-5xl animate-section">
            <header class="mb-12 flex flex-col md:flex-row justify-between items-start md:items-end gap-10">
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-indigo-100 shadow-xl">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                        </div>
                        <span class="text-indigo-600 font-bold tracking-tighter text-2xl">HyperTransfer</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <h1 class="text-5xl font-extrabold text-[#0f172a] tracking-tight">Portal <span
                                class="text-slate-400 font-medium">Interface</span></h1>
                        <span class="h-8 w-[1px] bg-slate-200 mx-1"></span>
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Session
                                ID</span>
                            <code id="session-display"
                                class="bg-white text-indigo-600 px-3 py-1 rounded-lg text-xs font-mono font-black border border-indigo-100 select-all shadow-sm">Loading...</code>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3 p-2 bg-white border border-slate-200 rounded-[24px] shadow-sm">
                    <button id="main-send-session-btn" onclick="openSessionEmailModal()"
                        class="px-6 py-3 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 text-xs font-bold transition-all shadow-indigo-100 shadow-lg flex items-center gap-2 whitespace-nowrap">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                        SEND PORTAL
                    </button>
                    <button id="zip-btn" onclick="downloadSessionZip()"
                        class="px-5 py-3 bg-white text-slate-600 rounded-2xl hover:bg-slate-50 text-xs font-bold transition-all border border-slate-200 flex items-center gap-2">
                        ZIP FILE
                        <div id="zip-spinner"
                            class="hidden w-3 h-3 border-2 border-indigo-600/30 border-t-indigo-600 rounded-full animate-spin">
                        </div>
                    </button>
                    <button onclick="copySessionLink()"
                        class="px-5 py-3 bg-white text-slate-600 rounded-2xl hover:bg-slate-50 text-xs font-bold transition-all border border-slate-200 flex items-center gap-2 whitespace-nowrap">
                        COPY URL
                    </button>
                </div>
            </header>

            <!-- Mode Selector (Segmented Control) -->
            <div
                class="bg-slate-200/50 p-1.5 rounded-2xl mb-10 flex items-center w-fit segmented-control border border-slate-200/40">
                <span class="px-6 text-[10px] font-extrabold text-slate-500 uppercase tracking-[0.2em]">Paste
                    Mode</span>
                <div class="flex gap-1.5">
                    <label class="cursor-pointer">
                        <input type="radio" name="pasteType" value="auto" checked class="peer sr-only">
                        <span
                            class="px-7 py-3 rounded-xl text-slate-500 text-xs font-bold transition-all inline-block hover:text-slate-700">Auto</span>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="pasteType" value="text" class="peer sr-only">
                        <span
                            class="px-7 py-3 rounded-xl text-slate-500 text-xs font-bold transition-all inline-block hover:text-slate-700">Text</span>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="pasteType" value="image" class="peer sr-only">
                        <span
                            class="px-7 py-3 rounded-xl text-slate-500 text-xs font-bold transition-all inline-block hover:text-slate-700">Image</span>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="pasteType" value="grid" class="peer sr-only">
                        <span
                            class="px-7 py-3 rounded-xl text-slate-500 text-xs font-bold transition-all inline-block hover:text-slate-700">Excel</span>
                    </label>
                </div>
            </div>

            <!-- Paste Area -->
            <div id="paste-zone" onclick="focusPasteArea()"
                class="paste-zone bg-white rounded-[40px] p-16 md:p-24 text-center mb-10 relative overflow-hidden group border border-slate-200 shadow-sm cursor-pointer hover:shadow-indigo-100 hover:shadow-2xl">

                <textarea id="mobile-paste-area"
                    class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-20 resize-none overflow-hidden"
                    readonly></textarea>
                <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="handleFileSelect(event)">

                <div class="relative z-10 pointer-events-none">
                    <div
                        class="w-24 h-24 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto mb-8 group-hover:scale-110 group-hover:rotate-3 transition-all duration-500 shadow-inner">
                        <svg class="w-12 h-12 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                    </div>
                    <h3 class="text-3xl font-extrabold text-[#0f172a] mb-4 tracking-tight">Drop, Paste, or Tap to Upload
                    </h3>
                    <p id="paste-hint" class="text-slate-400 text-base mb-10 font-medium">Text snippets, Images, and
                        Tabular data items</p>

                    <button onclick="triggerFileUpload(event)"
                        class="pointer-events-auto px-10 py-4 bg-indigo-50 text-indigo-700 rounded-2xl hover:bg-indigo-100 transition-all text-sm font-bold shadow-sm shadow-indigo-100 uppercase tracking-widest">
                        üìÅ Choose Files
                    </button>
                </div>
            </div>

            <!-- Manual Text Input -->
            <div class="premium-card rounded-[32px] p-8 mb-16 shadow-lg shadow-slate-100">
                <div class="flex flex-col gap-5">
                    <div
                        class="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] px-1">
                        <div class="w-2 h-2 bg-indigo-400 rounded-full animate-pulse"></div>
                        Direct Input Terminal
                    </div>
                    <textarea id="manual-text-input"
                        placeholder="Type content for instant broadcast across your portal devices..."
                        class="w-full h-32 p-6 bg-slate-50 border border-slate-100 rounded-3xl text-sm focus:outline-none focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-400/50 transition-all resize-none font-sans text-slate-700 placeholder:text-slate-300"></textarea>
                    <div class="flex justify-end">
                        <button onclick="sendManualText()"
                            class="px-10 py-4 bg-[#0f172a] text-white rounded-[20px] hover:bg-indigo-950 text-xs font-black uppercase tracking-[0.2em] transition-all shadow-xl active:scale-95 flex items-center gap-3">
                            <span>SEND TO PORTAL</span>
                            <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Uploads -->
            <div class="premium-card rounded-[40px] overflow-hidden shadow-2xl shadow-slate-200/40">
                <div
                    class="px-10 py-8 border-b border-slate-50 flex justify-between items-center bg-white shadow-sm relative z-10">
                    <h2 class="font-black text-[#0f172a] flex items-center gap-4 text-2xl tracking-tighter">
                        Portal History
                        <span id="item-count"
                            class="bg-[#0f172a] text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">0
                            ITEMS</span>
                    </h2>
                    <button onclick="fetchUploads()"
                        class="text-xs text-indigo-600 hover:text-indigo-800 font-black uppercase tracking-[0.15em] flex items-center gap-2 bg-indigo-50/80 px-6 py-3 rounded-2xl transition-all border border-indigo-100/50">
                        REFRESH
                    </button>
                </div>
                <div id="uploads-list" class="divide-y divide-slate-50 bg-white min-h-[400px]">
                    <div class="p-24 text-center">
                        <div
                            class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                            <svg class="w-8 h-8 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <p class="text-slate-300 font-bold uppercase tracking-widest text-[11px]">Initializing Portal
                            Stream...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Preview -->
    <div id="modal"
        class="hidden fixed inset-0 bg-[#0f172a]/80 backdrop-blur-xl z-50 flex items-center justify-center p-4">
        <div
            class="bg-white rounded-[40px] shadow-2xl max-w-5xl w-full max-h-[92vh] overflow-hidden flex flex-col relative animate-section border border-white/20">
            <div class="flex justify-between items-center px-10 py-8 border-b border-slate-50 bg-white">
                <h3 id="modal-title" class="font-black text-[#0f172a] text-2xl tracking-tighter uppercase">Preview Mode
                </h3>
                <button onclick="closeModal()"
                    class="text-slate-400 hover:text-[#0f172a] bg-slate-50 rounded-full p-2.5 hover:bg-slate-100 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                            d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div id="modal-content"
                class="p-0 overflow-auto flex-grow bg-slate-50 min-h-[400px] flex items-center justify-center relative">
                <!-- Content injected here -->
            </div>

            <div class="p-10 border-t border-slate-100 bg-white">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-10 items-end">
                    <div class="md:col-span-8 space-y-4">
                        <label
                            class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] ml-1 block">Broadcast
                            Relay (Sandbox Mode)</label>
                        <div class="flex gap-3">
                            <input type="email" id="target-email" value="chongcclhkchatgpt@gmail.com"
                                placeholder="Recipient portal address..."
                                class="flex-grow px-6 py-4.5 bg-slate-50 border border-slate-100 rounded-2xl text-sm focus:outline-none focus:ring-4 focus:ring-indigo-500/5 focus:border-indigo-400 transition-all font-bold text-slate-700 placeholder:text-slate-300">
                            <button id="send-btn" onclick="handleSendEmail()"
                                class="px-10 py-4.5 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 text-xs font-black uppercase tracking-[0.2em] transition-all shadow-xl shadow-indigo-100 disabled:opacity-50 flex items-center gap-3">
                                <span>RELAY</span>
                                <div id="loading-spinner"
                                    class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin">
                                </div>
                            </button>
                        </div>
                    </div>

                    <div class="md:col-span-4 h-full flex flex-col justify-end">
                        <button id="modal-copy-btn" onclick="copyModalContent()"
                            class="w-full py-4.5 bg-[#0f172a] text-white rounded-2xl hover:bg-indigo-950 text-xs font-black uppercase tracking-[0.2em] transition-all flex items-center justify-center gap-3 shadow-lg">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                            SYNC CLIPBOARD
                        </button>
                    </div>
                </div>
                <p id="send-status"
                    class="text-[11px] font-bold hidden italic text-center mt-6 text-indigo-600 tracking-wide"></p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ifoufoxtbuugsoixaccy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlmb3Vmb3h0YnV1Z3NvaXhhY2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NTIzNzAsImV4cCI6MjA4NzAyODM3MH0.EwtRGGrpXFulRKGL1RoHyDJ7RPafIPd-apmezCnVfog';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentActiveItem = null;
        let isSessionMode = false;
        let selectionMode = false;
        let selectedSessions = new Set();
        let loadedSessionIds = []; // Track currently visible sessions for select all

        // Session Logic
        let sessionId = new URLSearchParams(window.location.search).get('session');
        if (!sessionId) {
            sessionId = crypto.randomUUID().split('-')[0];
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('session', sessionId);
            window.history.replaceState({}, '', newUrl);
        }
        document.getElementById('session-display').textContent = sessionId;

        // Global History Logic (Replaces localStorage)
        async function loadHistory() {
            const list = document.getElementById('session-history-list');

            try {
                // Fetch the most recent 100 uploads to identify active sessions
                const { data, error } = await supabaseClient
                    .from('transfer_uploads')
                    .select('session_id, created_at')
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (error) throw error;

                // Extract unique session IDs in order
                const sessions = [];
                const seen = new Set();

                if (data) {
                    data.forEach(item => {
                        if (!seen.has(item.session_id)) {
                            seen.add(item.session_id);
                            sessions.push(item.session_id);
                        }
                    });
                }

                // Update tracker for select-all
                loadedSessionIds = sessions.slice(0, 15);

                if (sessions.length === 0) {
                    list.innerHTML = '<div class="text-xs text-slate-400">No active sessions found.</div>';
                    return;
                }

                list.innerHTML = '';
                // Limit to top 15 most recent
                sessions.slice(0, 15).forEach(id => {
                    const active = id === sessionId;
                    const container = document.createElement('div');
                    container.className = "flex items-center gap-1 group/item";

                    if (selectionMode) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = "w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 mr-1";
                        checkbox.checked = selectedSessions.has(id);
                        checkbox.onclick = (e) => {
                            e.stopPropagation();
                            if (checkbox.checked) selectedSessions.add(id);
                            else selectedSessions.delete(id);
                            updateBulkActionUI();
                        };
                        container.appendChild(checkbox);
                    }

                    const btn = document.createElement('button');
                    btn.className = `flex-grow text-left px-3 py-2 rounded-lg text-sm transition-all flex items-center justify-between ${active ? 'bg-blue-50 text-blue-700 font-bold border border-blue-100' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900 border border-transparent'}`;
                    btn.innerHTML = `
                        <span class="truncate"># ${id}</span>
                        ${active && !selectionMode ? '<span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>' : ''}
                    `;
                    btn.onclick = () => {
                        if (selectionMode) {
                            if (selectedSessions.has(id)) selectedSessions.delete(id);
                            else selectedSessions.add(id);
                            loadHistory();
                            updateBulkActionUI();
                            return;
                        }
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('session', id);
                        window.location.href = newUrl.toString();
                    };

                    if (!selectionMode) {
                        const delBtn = document.createElement('button');
                        delBtn.className = "p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover/item:opacity-100";
                        delBtn.innerHTML = `
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        `;
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            confirmDeleteSession(id);
                        };
                        container.appendChild(btn);
                        container.appendChild(delBtn);
                    } else {
                        container.appendChild(btn);
                    }

                    list.appendChild(container);
                });
            } catch (err) {
                console.error('History Load Error:', err);
                list.innerHTML = '<div class="text-xs text-red-400">Error loading history.</div>';
            }
        }

        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            if (!selectionMode) selectedSessions.clear();

            document.getElementById('bulk-actions').classList.toggle('hidden', !selectionMode);
            document.getElementById('new-session-btn').classList.toggle('hidden', selectionMode);
            document.getElementById('sidebar-divider').classList.toggle('hidden', selectionMode);
            document.getElementById('manage-btn').textContent = selectionMode ? 'Cancel' : 'Manage';

            loadHistory();
            updateBulkActionUI();
        }

        function toggleSelectAll() {
            if (selectedSessions.size === loadedSessionIds.length) {
                // All selected, so deselect all
                selectedSessions.clear();
            } else {
                // Select all currently visible
                loadedSessionIds.forEach(id => selectedSessions.add(id));
            }
            loadHistory();
            updateBulkActionUI();
        }

        function updateBulkActionUI() {
            const delBtn = document.getElementById('bulk-del-btn');
            const selectAllBtn = document.getElementById('select-all-btn');

            delBtn.textContent = `üóëÔ∏è Delete Selected (${selectedSessions.size})`;
            delBtn.disabled = selectedSessions.size === 0;
            delBtn.style.opacity = selectedSessions.size === 0 ? '0.5' : '1';

            if (selectedSessions.size > 0 && selectedSessions.size === loadedSessionIds.length) {
                selectAllBtn.textContent = 'Deselect All';
                selectAllBtn.classList.replace('text-slate-600', 'text-blue-600');
            } else {
                selectAllBtn.textContent = 'Select All';
                selectAllBtn.classList.replace('text-blue-600', 'text-slate-600');
            }
        }

        async function deleteSelectedSessions() {
            if (selectedSessions.size === 0) return;
            const targetIds = Array.from(selectedSessions);
            if (!confirm(`Are you sure you want to delete ${targetIds.length} sessions? This cannot be undone.`)) return;

            try {
                const { error } = await supabaseClient
                    .from('transfer_uploads')
                    .delete()
                    .in('session_id', targetIds);

                if (error) throw error;

                const currentSessionDeleted = selectedSessions.has(sessionId);
                toggleSelectionMode(); // Reset mode

                if (currentSessionDeleted) {
                    startNewSession();
                } else {
                    loadHistory();
                }
            } catch (err) {
                console.error('Bulk Delete Error:', err);
                alert('Failed to delete sessions: ' + err.message);
            }
        }

        async function confirmDeleteSession(id) {
            if (!confirm(`Are you sure you want to delete session #${id}? This will remove all items in this session from Supabase.`)) return;

            try {
                const { error } = await supabaseClient
                    .from('transfer_uploads')
                    .delete()
                    .eq('session_id', id);

                if (error) throw error;

                if (id === sessionId) {
                    startNewSession();
                } else {
                    loadHistory();
                }
            } catch (err) {
                console.error('Delete Error:', err);
                alert('Failed to delete session: ' + err.message);
            }
        }

        function startNewSession() {
            const newId = crypto.randomUUID().split('-')[0];
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('session', newId);
            window.location.href = newUrl.toString();
        }

        function copySessionLink() {
            navigator.clipboard.writeText(window.location.href);
            const btn = document.querySelector('button[onclick="copySessionLink()"]');
            btn.textContent = '‚úÖ Copied!';
            setTimeout(() => btn.innerHTML = 'üîó Copy Link', 2000);
        }

        // Paste & Upload Logic
        function focusPasteArea() {
            const area = document.getElementById('mobile-paste-area');
            area.focus();
        }

        function triggerFileUpload(e) {
            e.stopPropagation();
            document.getElementById('file-upload').click();
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                await handleImage(file);
                showPasteSuccess();
                setTimeout(fetchUploads, 800);
            }
        }

        function showPasteSuccess() {
            const zone = document.getElementById('paste-zone');
            zone.classList.add('border-green-500', 'bg-green-50');
            setTimeout(() => zone.classList.remove('border-green-500', 'bg-green-50'), 500);
        }

        async function processPaste(clipboardData) {
            const mode = document.querySelector('input[name="pasteType"]:checked').value;
            const items = clipboardData.items;
            let handled = false;

            if (mode === 'image' || mode === 'auto') {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        await handleImage(items[i].getAsFile());
                        handled = true;
                        break;
                    }
                }
            }
            if (!handled && (mode === 'grid' || mode === 'auto')) {
                const html = clipboardData.getData('text/html');
                if (html && html.includes('<table')) {
                    await handleGrid(html);
                    handled = true;
                }
            }
            if (!handled && (mode === 'text' || mode === 'auto')) {
                const text = clipboardData.getData('text/plain');
                if (text && text.trim().length > 0) {
                    await handleText(text);
                    handled = true;
                }
            }

            if (handled) {
                showPasteSuccess();
                setTimeout(fetchUploads, 800);
            }
        }

        // Handle global paste
        window.addEventListener('paste', async (e) => {
            await processPaste(e.clipboardData);
        });

        // Handle mobile-specific textarea paste
        document.getElementById('mobile-paste-area').addEventListener('paste', async (e) => {
            // Usually redundant with global listener, but ensures focus works on all mobiles
            await processPaste(e.clipboardData);
        });

        async function sendManualText() {
            const input = document.getElementById('manual-text-input');
            const text = input.value.trim();

            if (!text) {
                alert('Please enter some text first.');
                return;
            }

            try {
                await handleText(text);
                input.value = ''; // Clear input
                showPasteSuccess(); // Visual feedback
                setTimeout(fetchUploads, 800);
            } catch (err) {
                console.error('Manual Upload Error:', err);
                alert('Failed to send text: ' + err.message);
            }
        }

        async function handleImage(blob) {
            const reader = new FileReader();
            reader.onload = async (event) => uploadItem('image', event.target.result);
            reader.readAsDataURL(blob);
        }
        async function handleGrid(html) { uploadItem('grid', html); }
        async function handleText(text) { uploadItem('text', text); }

        async function uploadItem(type, content) {
            const { error } = await supabaseClient
                .from('transfer_uploads')
                .insert([{ type, content, session_id: sessionId }]);
            if (error) alert('Upload failed: ' + error.message);
            else {
                // Refresh history after upload to ensure current session is at the top
                loadHistory();
            }
        }

        async function fetchUploads() {
            const container = document.getElementById('uploads-list');
            const { data, error } = await supabaseClient
                .from('transfer_uploads')
                .select('*')
                .eq('session_id', sessionId)
                .order('created_at', { ascending: false });

            if (error) return;
            document.getElementById('item-count').textContent = data.length;

            if (data.length === 0) {
                container.innerHTML = '<div class="p-12 text-center text-slate-400">No items yet. Paste something above!</div>';
                return;
            }

            container.innerHTML = '';
            data.forEach(item => {
                const el = document.createElement('div');
                el.className = 'p-4 hover:bg-slate-50 transition-colors flex items-center gap-4 cursor-pointer group relative';
                el.onclick = () => showModal(item);

                let icon = item.type === 'image' ? 'üñºÔ∏è' : item.type === 'grid' ? 'üìä' : 'üìù';
                let preview = item.type === 'image' ? `<img src="${item.content}" class="h-10 w-10 object-cover rounded shadow-sm">` : `<div class="truncate text-sm text-slate-500 max-w-sm font-mono">${item.content.trim().substring(0, 80)}</div>`;

                el.innerHTML = `
                    <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-slate-100 rounded-lg text-lg">${icon}</div>
                    <div class="flex-grow min-w-0">
                        <div class="font-bold text-xs text-slate-400 uppercase tracking-tighter mb-0.5">${item.type}</div>
                        ${preview}
                    </div>
                    <div class="text-xs text-slate-400 font-medium whitespace-nowrap">${new Date(item.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    <div class="ml-2 group-hover:translate-x-1 transition-transform opacity-30 group-hover:opacity-100">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function showModal(item) {
            currentActiveItem = item;
            isSessionMode = false;
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            const status = document.getElementById('send-status');
            const title = document.getElementById('modal-title');

            status.classList.add('hidden');
            modal.classList.remove('hidden');
            title.textContent = "Content Preview";

            content.className = "p-4 overflow-auto flex-grow bg-slate-50 w-full flex items-center justify-center";

            if (item.type === 'image') {
                content.innerHTML = `<img src="${item.content}" class="max-w-full max-h-[60vh] rounded shadow-lg">`;
            } else if (item.type === 'grid') {
                content.innerHTML = `<div class="bg-white p-6 border rounded shadow-sm overflow-auto text-xs prose-sm w-full max-w-full h-full">${item.content}</div>`;
            } else {
                content.innerHTML = `<pre class="bg-slate-900 text-green-400 p-8 rounded-xl font-mono text-sm whitespace-pre-wrap w-full h-full overflow-auto shadow-inner border border-slate-700">${item.content.replace(/</g, '&lt;')}</pre>`;
            }
        }

        async function copyModalContent() {
            if (!currentActiveItem) return;

            const btn = document.getElementById('modal-copy-btn');
            const originalText = btn.innerHTML;

            try {
                if (currentActiveItem.type === 'image') {
                    // Try to copy as actual image blob
                    try {
                        const response = await fetch(currentActiveItem.content);
                        const blob = await response.blob();
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                [blob.type]: blob
                            })
                        ]);
                    } catch (err) {
                        // Fallback to copying data URL as text
                        await navigator.clipboard.writeText(currentActiveItem.content);
                    }
                } else {
                    // For text or grid, copy as text
                    await navigator.clipboard.writeText(currentActiveItem.content);
                }

                btn.innerHTML = '‚úÖ Copied!';
                btn.classList.replace('bg-slate-100', 'bg-green-100');
                btn.classList.replace('text-slate-600', 'text-green-700');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-green-100', 'bg-slate-100');
                    btn.classList.replace('text-green-700', 'text-slate-600');
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Copy failed: ' + err.message);
            }
        }

        function openSessionEmailModal() {
            currentActiveItem = null;
            isSessionMode = true;
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            const status = document.getElementById('send-status');
            const title = document.getElementById('modal-title');

            status.classList.add('hidden');
            modal.classList.remove('hidden');
            title.textContent = "Send Session Report";

            content.innerHTML = `
                <div class="text-center p-8">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <h3 class="text-lg font-bold text-slate-700 mb-2 font-mono">Session ${sessionId}</h3>
                    <p class="text-slate-500 text-sm">This will compile all pastes in this session into a single email report.</p>
                </div>
            `;
        }

        async function handleSendEmail() {
            const email = document.getElementById('target-email').value;
            const status = document.getElementById('send-status');
            const btn = document.getElementById('send-btn');
            const spinner = document.getElementById('loading-spinner');

            if (!email || !email.includes('@')) { alert('Please enter a valid email'); return; }

            btn.disabled = true;
            spinner.classList.remove('hidden');
            status.textContent = 'Sending...';
            status.className = 'text-xs text-blue-600 mt-1';
            status.classList.remove('hidden');

            try {
                const payload = isSessionMode
                    ? { to: email, sessionId: sessionId, report: true }
                    : { to: email, type: currentActiveItem.type, content: currentActiveItem.content, sessionId: sessionId };

                const res = await fetch('/api/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = await res.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    const errorMsg = text.length > 200 ? text.substring(0, 200) + '...' : text;
                    throw new Error("Server returned non-JSON (" + res.status + "): " + errorMsg);
                }

                if (!res.ok) throw new Error(result.error || 'Send failed');
                status.textContent = '‚úÖ Sent!';
                status.className = 'text-xs text-green-600 mt-1';
            } catch (err) {
                console.error('Email Error:', err);
                status.textContent = '‚ùå ' + err.message;
                status.className = 'text-xs text-red-600 mt-1 leading-relaxed';
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        async function downloadSessionZip() {
            const btn = document.getElementById('zip-btn');
            const spinner = document.getElementById('zip-spinner');

            btn.disabled = true;
            spinner.classList.remove('hidden');

            try {
                const { data, error } = await supabaseClient
                    .from('transfer_uploads')
                    .select('*')
                    .eq('session_id', sessionId)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                if (!data || data.length === 0) {
                    alert('No items to download in this session.');
                    return;
                }

                const zip = new JSZip();
                const sessionFolder = zip.folder(`session_${sessionId}`);

                data.forEach((item, index) => {
                    const timestamp = new Date(item.created_at).getTime();
                    if (item.type === 'image') {
                        // Extract base64 part
                        const base64Data = item.content.split(',')[1];
                        sessionFolder.file(`image_${index}_${timestamp}.png`, base64Data, { base64: true });
                    } else if (item.type === 'grid') {
                        sessionFolder.file(`grid_${index}_${timestamp}.html`, `<html><body>${item.content}</body></html>`);
                    } else {
                        sessionFolder.file(`text_${index}_${timestamp}.txt`, item.content);
                    }
                });

                const content = await zip.generateAsync({ type: "blob" });
                const url = window.URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `HyperTransfer_Session_${sessionId}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                console.error('ZIP Error:', err);
                alert('Failed to generate ZIP: ' + err.message);
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });

        // Init
        loadHistory();
        fetchUploads();
    </script>
</body>

</html>
